<!DOCTYPE html>
<html lang="ja">
<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚²ãƒ¼ãƒ éƒ¨ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼</title>

<style>
body{
  margin:0;
  font-family: system-ui, sans-serif;
  background:#e8f4ff;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}

/* ===== ã‚«ãƒ¼ãƒ‰ ===== */
.card{
  background:white;
  padding:28px;
  border-radius:22px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  width:320px;
  text-align:center;
}

/* ===== ã‚¿ã‚¤ãƒˆãƒ« ===== */
.title{
  font-size:20px;
  font-weight:bold;
  margin-bottom:18px;
  color:#2b3a55;
}

/* ===== å…¥åŠ› ===== */
input{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:16px;
}

/* ===== ãƒœã‚¿ãƒ³ ===== */
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}

/* ãƒ­ã‚°ã‚¤ãƒ³ */
.login-btn{
  background:#06c755;
  color:white;
}

/* PTT */
.ptt{
  background:#4da3ff;
  color:white;
  font-size:18px;
  margin-top:16px;
  transition:.15s;
}

.ptt.active{
  background:#ff5252;
  transform:scale(0.96);
}

/* ãƒ­ãƒƒã‚¯è¡¨ç¤º */
.lock{
  margin-top:10px;
  font-size:14px;
  color:#666;
}
</style>
</head>
<body>

<div class="card" id="loginCard">
  <div class="title">ã‚²ãƒ¼ãƒ éƒ¨ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼</div>
  <input id="groupId" placeholder="å‚åŠ ã‚³ãƒ¼ãƒ‰">
  <input id="pin" placeholder="PIN">
  <button class="login-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div class="card" id="talkCard" style="display:none;">
  <div class="title">ğŸ™ ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼</div>
  <button id="pttBtn" class="ptt">æŠ¼ã—ã¦è©±ã™</button>
  <div class="lock" id="lockState">ãƒ­ãƒƒã‚¯ï¼šOFF</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCOAvu39P6g6Vbli8P3nKMKWjaKQwv5PdA",
  authDomain: "chat-63a9f.firebaseapp.com",
  projectId: "chat-63a9f",
  storageBucket: "chat-63a9f.firebasestorage.app",
  messagingSenderId: "678493610024",
  appId: "1:678493610024:web:642d1f88d11578753f151d",
  measurementId: "G-RW9DY5HT6T"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== PINä¸€è¦§ ===== */
const PINS = [
"52643798","47295836","42735698","86547329","26593847",
"58932467","26493785","46395728","27936854","89724536","69852473"
];

let myPin = "";
let audioStream = null;
let mediaRecorder = null;
let isLocked = false;
let isTalking = false;

/* ===== ãƒ­ã‚°ã‚¤ãƒ³ ===== */
window.login = () => {
  const gid = document.getElementById("groupId").value.trim();
  const pin = document.getElementById("pin").value.trim();

  if (gid !== "Suc000001") return alert("å‚åŠ ã‚³ãƒ¼ãƒ‰é•ã†");
  if (!PINS.includes(pin)) return alert("PINé•ã†");

  myPin = pin;

  document.getElementById("loginCard").style.display="none";
  document.getElementById("talkCard").style.display="block";

  initAudio();
};

/* ===== éŸ³å£°åˆæœŸåŒ– ===== */
async function initAudio(){
  audioStream = await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder = new MediaRecorder(audioStream);

  mediaRecorder.ondataavailable = async e=>{
    if(e.data.size===0) return;

    const arrayBuffer = await e.data.arrayBuffer();

    await setDoc(doc(db,"voice","live"),{
      blob: Array.from(new Uint8Array(arrayBuffer)),
      pin: myPin,
      time: serverTimestamp()
    });
  };

  listenVoice();
}

/* ===== å—ä¿¡ ===== */
function listenVoice(){
  onSnapshot(doc(db,"voice","live"),snap=>{
    const d = snap.data();
    if(!d) return;
    if(d.pin===myPin) return;

    const audio = new Audio(
      URL.createObjectURL(
        new Blob([new Uint8Array(d.blob)],{type:"audio/webm"})
      )
    );
    audio.play();
  });
}

/* ===== PTT ===== */
const btn = document.getElementById("pttBtn");

/* ãƒˆã‚°ãƒ«å¯¾è±¡PIN */
const TOGGLE_PIN = "52643798";

/* æŠ¼ã™ */
btn.addEventListener("mousedown",()=>{
  if(myPin===TOGGLE_PIN){
    toggleTalk();
  }else{
    startTalk();
  }
});

/* é›¢ã™ */
btn.addEventListener("mouseup",()=>{
  if(myPin===TOGGLE_PIN) return;
  stopTalk();
});

/* ===== ãƒˆã‚°ãƒ« ===== */
function toggleTalk(){
  isLocked = !isLocked;
  document.getElementById("lockState").textContent =
    "ãƒ­ãƒƒã‚¯ï¼š" + (isLocked ? "ON" : "OFF");

  if(isLocked){
    startTalk();
  }else{
    stopTalk();
  }
}

/* ===== é€ä¿¡é–‹å§‹ ===== */
function startTalk(){
  if(isTalking) return;
  isTalking = true;
  btn.classList.add("active");
  btn.textContent = "é€ä¿¡ä¸­â€¦";
  mediaRecorder.start(300); // â†ä½é…å»¶
}

/* ===== é€ä¿¡åœæ­¢ ===== */
function stopTalk(){
  if(!isTalking) return;
  isTalking = false;
  btn.classList.remove("active");
  btn.textContent = "æŠ¼ã—ã¦è©±ã™";
  mediaRecorder.stop();
}
</script>
</body>
</html>
